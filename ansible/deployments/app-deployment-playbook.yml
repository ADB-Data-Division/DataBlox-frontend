---
- name: Deploy Capacity Building Visualization App
  hosts: azure_vm
  become: yes
  vars:
      app_image: "ghcr.io/darrensapalo/capacity-building-visualization:latest"
      app_name: "capacity-building-viz"
      app_port: "3000"
      domain: "adb.sapalo.dev" # Your actual domain

  tasks:
      - name: Pull latest application image
        shell: docker pull {{ app_image }}
        become_user: "{{ ansible_user }}"
        register: pull_result

      - name: Display pull result
        debug:
            msg: "Image pull {{ 'successful' if pull_result.rc == 0 else 'failed' }}"

      - name: Stop existing container if running
        shell: docker stop {{ app_name }}
        ignore_errors: yes
        become_user: "{{ ansible_user }}"

      - name: Remove existing container
        shell: docker rm {{ app_name }}
        ignore_errors: yes
        become_user: "{{ ansible_user }}"

      - name: Check if traefik network exists
        shell: docker network ls | grep traefik
        register: traefik_network_check
        ignore_errors: yes
        become_user: "{{ ansible_user }}"

      - name: Create traefik network if it doesn't exist
        shell: docker network create traefik
        when: traefik_network_check.rc != 0
        become_user: "{{ ansible_user }}"

      - name: Run new container with Traefik labels
        shell: |
            docker run -d \
              --name {{ app_name }} \
              --network traefik \
              --restart unless-stopped \
              -p {{ app_port }}:3000 \
              -l "traefik.enable=true" \
              -l "traefik.http.routers.{{ app_name }}.rule=Host(\`{{ domain }}\`)" \
              -l "traefik.http.routers.{{ app_name }}.entrypoints=web" \
              -l "traefik.http.routers.{{ app_name }}-secure.rule=Host(\`{{ domain }}\`)" \
              -l "traefik.http.routers.{{ app_name }}-secure.entrypoints=websecure" \
              -l "traefik.http.routers.{{ app_name }}-secure.tls=true" \
              -l "traefik.http.routers.{{ app_name }}-secure.tls.certresolver=letsencrypt" \
              -l "traefik.http.middlewares.{{ app_name }}-redirect.redirectscheme.scheme=https" \
              -l "traefik.http.middlewares.{{ app_name }}-redirect.redirectscheme.permanent=true" \
              -l "traefik.http.routers.{{ app_name }}.middlewares={{ app_name }}-redirect" \
              -l "traefik.http.services.{{ app_name }}.loadbalancer.server.port=3000" \
              {{ app_image }}
        become_user: "{{ ansible_user }}"
        register: container_run

      - name: Display container run result
        debug:
            msg: "Container {{ 'started successfully' if container_run.rc == 0 else 'failed to start' }}"

      - name: Wait for container to be healthy
        pause:
            seconds: 10

      - name: Check container status
        shell: docker ps --filter "name={{ app_name }}"
        become_user: "{{ ansible_user }}"
        register: container_status

      - name: Display container status
        debug:
            var: container_status.stdout_lines

      - name: Test application accessibility
        uri:
            url: "http://localhost:{{ app_port }}"
            method: GET
            timeout: 10
        ignore_errors: yes
        register: health_check

      - name: Display health check result
        debug:
            msg: "Application is {{ 'accessible' if health_check.status == 200 else 'not accessible' }} on localhost:{{ app_port }}"

      - name: Display access instructions
        debug:
            msg: |
                Deployment complete! 

                Local access: http://localhost:{{ app_port }}
                External access: http://{{ domain }}:{{ app_port }}

                Via Traefik with SSL: https://{{ domain }}
                Via Traefik HTTP (redirects to HTTPS): http://{{ domain }}

                To check logs: docker logs {{ app_name }}
                To check status: docker ps --filter "name={{ app_name }}"
                To check Traefik logs: docker logs traefik
