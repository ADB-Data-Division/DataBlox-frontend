---
- name: Install Docker and Docker Compose
  hosts: azure_vm
  become: yes
  tasks:
      - name: Update apt package index
        apt:
            update_cache: yes
            cache_valid_time: 3600

      - name: Install prerequisites
        apt:
            name:
                - ca-certificates
                - curl
                - gnupg
                - lsb-release
            state: present

      - name: Create directory for Docker's GPG key
        file:
            path: /etc/apt/keyrings
            state: directory
            mode: "0755"

      - name: Add Docker's official GPG key
        shell: |
            curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
            chmod a+r /etc/apt/keyrings/docker.gpg
        args:
            creates: /etc/apt/keyrings/docker.gpg

      - name: Get Ubuntu release codename
        shell: lsb_release -cs
        register: ubuntu_codename
        changed_when: false

      - name: Get system architecture
        shell: dpkg --print-architecture
        register: system_architecture
        changed_when: false

      - name: Add Docker repository
        apt_repository:
            repo: "deb [arch={{ system_architecture.stdout }} signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu {{ ubuntu_codename.stdout }} stable"
            state: present

      - name: Update apt package index after adding Docker repo
        apt:
            update_cache: yes

      - name: Install Docker Engine and related packages
        apt:
            name:
                - docker-ce
                - docker-ce-cli
                - containerd.io
                - docker-buildx-plugin
                - docker-compose-plugin
            state: present

      - name: Start and enable Docker service
        systemd:
            name: docker
            state: started
            enabled: yes

      - name: Add user to docker group
        user:
            name: "{{ ansible_user }}"
            groups: docker
            append: yes

      - name: Test Docker installation
        shell: docker run hello-world
        register: docker_test
        changed_when: false

      - name: Display Docker test result
        debug:
            var: docker_test.stdout

      - name: Test Docker Compose installation
        shell: docker compose version
        register: compose_test
        changed_when: false

      - name: Display Docker Compose version
        debug:
            var: compose_test.stdout
